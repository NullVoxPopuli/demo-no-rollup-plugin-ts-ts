{"version":3,"file":"to-broccoli-plugin.js","sourceRoot":"","sources":["to-broccoli-plugin.ts"],"names":[],"mappings":";;;;;AAAA,sEAAqC;AAGrC,kEAAqD;AAMrD,SAAwB,gBAAgB,CACtC,aAA2C;IAE3C,MAAM,cAAe,SAAQ,yBAAM;QAEjC,YAAoB,KAAY,EAAU,QAAmB,EAAU,OAAiB;YACtF,KAAK,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE;gBAClB,gBAAgB,EAAE,IAAI;gBACtB,UAAU,EAAE,KAAK;gBACjB,UAAU,EAAE,aAAa,CAAC,UAAU;aACrC,CAAC,CAAC;YALe,UAAK,GAAL,KAAK,CAAO;YAAU,aAAQ,GAAR,QAAQ,CAAW;YAAU,YAAO,GAAP,OAAO,CAAU;QAMxF,CAAC;QAED,KAAK,CAAC,KAAK;YACT,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;gBAClB,IAAI,EAAE,UAAU,EAAE,YAAY,EAAE,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,KAAK,EAAE,CAAC;gBAC5D,uEAAuE;gBACvE,oDAAoD;gBACpD,IAAI,YAAY,EAAE;oBAChB,YAAY,CAAC,OAAO,CAAC,kBAAkB,CAAC,CAAC;iBAC1C;gBACD,IAAI,CAAC,QAAQ,GAAG,IAAI,aAAa,CAC/B,UAAU,EACV,IAAI,CAAC,UAAU,EACf,IAAI,CAAC,QAAQ,EACb,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,KAAK,CAAC,yBAAM,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,EACrD,IAAI,CAAC,OAAO,CACb,CAAC;aACH;YACD,OAAO,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;QAC/B,CAAC;KACF;IACD,OAAO,cAAc,CAAC;AACxB,CAAC;AAjCD,mCAiCC","sourcesContent":["import Plugin from 'broccoli-plugin';\nimport { Packager, PackagerConstructor, Variant } from './packager';\nimport Stage from './stage';\nimport { tmpdir } from '@embroider/shared-internals';\n\ninterface BroccoliPackager<Options> {\n  new (stage: Stage, variants: Variant[], options?: Options): Plugin;\n}\n\nexport default function toBroccoliPlugin<Options>(\n  packagerClass: PackagerConstructor<Options>\n): BroccoliPackager<Options> {\n  class PackagerRunner extends Plugin {\n    private packager: Packager | undefined;\n    constructor(private stage: Stage, private variants: Variant[], private options?: Options) {\n      super([stage.tree], {\n        persistentOutput: true,\n        needsCache: false,\n        annotation: packagerClass.annotation,\n      });\n    }\n\n    async build() {\n      if (!this.packager) {\n        let { outputPath, packageCache } = await this.stage.ready();\n        // We always register a shared stage3 packageCache so it can be used by\n        // things like babel plugins and template compilers.\n        if (packageCache) {\n          packageCache.shareAs('embroider-stage3');\n        }\n        this.packager = new packagerClass(\n          outputPath,\n          this.outputPath,\n          this.variants,\n          msg => console.log(msg.split(tmpdir).join('$TMPDIR')),\n          this.options\n        );\n      }\n      return this.packager.build();\n    }\n  }\n  return PackagerRunner;\n}\n"]}